<div class="article-list change-logs--list">
  <article>
    <div class="isotope">
      <article
        id="{{substr .File.LogicalName 0 -3}}"
        class="page-section change-log"
      >
        <div class="article-content">
          <header class="section-header">
            <h1 class="text-light">{{replace (replace (replace .Title "var-company-sag" .Site.Params.company_sag) "var-enterprise-tenant" .Site.Params.enterprise_tenant) "var-product-c8y-iot" .Site.Params.product_c8y_iot}}</h1>
          </header>
          <div class="lead">
            {{ .Content }}
            <p class="small">Displaying the latest changes since {{site.Data.date_settings.date.Format "January 2, 2006"}}</p>
          </div>
        </div>
      </article>
      {{/*  Get the page resources from the right folder  */}}
      {{ $bundle := "/change-logs" }}
      {{ $headless := .Site.GetPage $bundle }}
      {{ $reusablePages := sort ($headless.Resources.ByType "page") ".Date" "desc"}}

      {{/*  retrieve the starting date from the settings  */}}
      {{ $currentDate := newScratch }}
      {{ $currentDate.Set "date" ""}}
      {{ $dateLimit := site.Data.date_settings.date }}

      {{ range where $reusablePages "Date" "ge" $dateLimit}}
      {{/*  Based on the yearly release boolean, retrives 
          * yearly_release: true -  show all entries
          * yearly_release: false - don't show "Fix" entries
         */}}
      {{$classes := slice}}
      {{ if site.Data.date_settings.yearly_release}}
      {{ $currentDate.Set "out" ""}}
      {{else}}
      {{ $currentDate.Set "out" "Fix"}}
      {{end}}

      {{ if ne (index .Params.change_type 0).label ($currentDate.Get "out")}}

      <!-- Dates, only adds a new one when it changes -->
      {{$listDate := .Date.Format "January 2, 2006" }}
      {{ if ne $listDate ($currentDate.Get "date")}}
      {{ $currentDate.Set "date" $listDate}}
       {{/*  pick the CSS class names from the entries sharing the same date  */}}
      {{ range $reusablePages }}
      {{ $recordDate := .Date.Format "January 2, 2006" }}
      {{ if eq $recordDate $listDate }}
      {{$changeTypeClass := print "change-type-" (index .Params.change_type 0).label | urlize}}
      {{$productAreaClass := print "productarea-" (index .Params.product_area 0).label | urlize}}
      {{$componentClass := print "component-" (index .Params.component 0).label | urlize}}
      {{$technicalComponentClass := print "technicalcomponent-" (index .Params.technical_component 0).label}}
      {{ if not (in $classes $changeTypeClass) }}
      {{$classes = $classes | append $changeTypeClass}}
      {{end}}
      {{ if not (in $classes $productAreaClass) }}
      {{$classes = $classes | append $productAreaClass}}
      {{end}}
      {{ if not (in $classes $componentClass) }}
      {{$classes = $classes | append $componentClass}}
      {{end}}
      {{ if not (in $classes $technicalComponentClass) }}
      {{$classes = $classes | append $technicalComponentClass}}
      {{end}}
      {{end}}
      {{end}}

      <div
        data-id="cl-{{$listDate | urlize }}"
        class="page-section change-log__date {{range $classes}}{{.}} {{end}}"
      >
        <h5>{{$listDate}}</h5>
      </div>
      {{end}}

      <section
        id="{{.Title | urlize }}"
        class="page-section change-type-{{(index .Params.change_type 0).label | urlize}}  productarea-{{(index .Params.product_area 0).label | urlize}}  component-{{ (index .Params.component 0).label | urlize }}  technicalcomponent-{{(index .Params.technical_component 0).label | urlize}}"
        data-date="{{.Date}}"
      >
        <div class="article-content change-log">
          <div class="change-log__header">
            <h2>
              {{replace .Title "var-product-c8y-iot" .Site.Params.product_c8y_iot}}
              <button
                title="Copy link"
                class="btn-link bookmark"
                data-clipboard-text="#{{.Name | urlize }}"
              >
                <span class="fa dlt-c8y-icon-link"></span>
              </button>
            </h2>
          </div>
          <div class="change-log__summary">
            {{ partial "change-log-labels.html" (index .Params.change_type 0).label}}
            <div>
              <small class="text-muted">Product area</small><br>
              <p>{{(index .Params.product_area 0).label}}</p>
            </div>
            <div>
              <small class="text-muted">Component</small>
              <p>{{(index .Params.component 0).label}}</p>
            </div>
            {{ if .Params.jira }}
            <div>
              <small class="text-muted">Ticket</small>
              <p>{{.Params.jira}}</p>
            </div>
            {{end}}
            {{/*  Display the build artifact and the version info only in yearly releases  */}}
            {{ if site.Data.date_settings.yearly_release}}
            <div>
              <small class="text-muted">Build artifact</small>
              <p>{{(index .Params.technical_component 0).label}}</p>
            </div>
            {{ if .Params.version}}
            <div>
              <small class="text-muted">Version</small>
              <p>{{.Params.version}}</p>
            </div>
            {{end}}
            {{end}}
          </div>
          {{.Content }}
        </div>
      </section>
      {{ end }}
      {{ end }}
    </div>
  </article>
</div>
