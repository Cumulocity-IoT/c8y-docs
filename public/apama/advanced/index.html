<!DOCTYPE html>
<html>
<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <base href="" />
    <meta name="generator" content="Hugo 0.54.0 with theme C8yDocs">
    <title>Advanced features - Cumulocity IoT Guides</title>
    <meta name="author" content="Carlos Ceia @ Cumulocity">
    <meta name="keywords" content=", Software AG Cloud, Cumulocity IoT, Internet of things, analytics, devices, connect">


    <link rel="icon" href="/favicon.ico">

    

    

    
    
    
    <link rel="stylesheet" href="https://cumulocity.com/guides/style.css">
    

      
      <script> window.zEmbed||function(e,t){var n,o,d,i,s,a=[],r=document.createElement("iframe");window.zEmbed=function(){a.push(arguments)},window.zE=window.zE||window.zEmbed,r.src="javascript:false",r.title="",r.role="presentation",(r.frameElement||r).style.cssText="display: none",d=document.getElementsByTagName("script"),d=d[d.length-1],d.parentNode.insertBefore(r,d),i=r.contentWindow,s=i.document;try{o=s}catch(c){n=document.domain,r.src='javascript:var d=document.open();d.domain="'+n+'";void(0);',o=s}o.open()._l=function(){var o=this.createElement("script");n&&(this.domain=n),o.id="js-iframe-async",o.src=e,this.t=+new Date,this.zendeskHost=t,this.zEQueue=a,this.body.appendChild(o)},o.write('<body onload="document._l();">'),o.close()}("https://assets.zendesk.com/embeddable_framework/main.js","cumulocity.zendesk.com"); </script>
        <script type="text/JavaScript">
          window.zESettings = {
            webWidget: {
              color: {
                theme: '#1776bf'    
              },
              position: {
                horizontal: 'right',
                vertical: 'top'     
              }
            }
          };
          </script>
        
        
   
  </head><body data-spy="scroll" data-target="#main-nav" ><button type="button" class="sidebar-toggle">
  <span class="icon-bar"></span>
  <span class="icon-bar"></span>
  <span class="icon-bar"></span>
  <span>MENU</span>
</button>
<nav class="main-top-bar" >
  <div class="d-flex container">
    <ul class="nav d-flex flex-start hidden-xs nav-left">
      <li><a href="https://www.softwareag.cloud/site/product/cumulocity-iot.html">Cumulocity IoT</a></li>
      <li><a href="http://resources.cumulocity.com/documentation/jssdk/latest/#/api">Cumulocity Angular API</a></li>
    </ul>
    <ul class="nav flex-end nav-right">
      <li>   <script>
              (function() {
                var cx = '008969372384807682938:yeh7xt785g4';
                var gcse = document.createElement('script');
                gcse.type = 'text/javascript';
                gcse.async = true;
                gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(gcse, s);
              })();
            </script>
        <div id="___gcse_0" dir="ltr"><form class="gsc-search-box gsc-search-box-tools" accept-charset="utf-8"><div class="table-responsive"><table cellspacing="0" cellpadding="0" class="gsc-search-box"><tbody><tr><td class="gsc-input"><div class="gsc-input-box" id="gsc-iw-id1"><table cellspacing="0" cellpadding="0" id="gs_id50" class="gstl_50 gsc-input" style="width: 100%; padding: 0px;"><tbody><tr><td id="gs_tti50" class="gsib_a"><input autocomplete="off" type="text" size="10" class="gsc-input" name="search" title="search" id="gsc-i-id1" placeholder="Custom Search" dir="ltr" spellcheck="false" x-webkit-grammar="builtin:search" lang="en" style="width: 100%; padding: 0px; border: none; margin: -0.0625em 0px 0px; height: 1.25em; background: url(&quot;https://www.google.com/cse/static/images/1x/googlelogo_lightgrey_46x16dp.png&quot;) left center no-repeat rgb(255, 255, 255); text-indent: 48px; outline: none;"></td><td class="gsib_b"><div class="gsst_b" id="gs_st50" dir="ltr"><a class="gsst_a" href="javascript:void(0)" style="display: none;" title="Clear search box" role="button"><span class="gscb_a" id="gs_cb50" aria-hidden="true">Ã—</span></a></div></td></tr></tbody></table></div></td><td class="gsc-search-button"><button class="gsc-search-button gsc-search-button-v2"><svg width="13" height="13" viewBox="0 0 13 13"><title>search</title><path d="m4.8495 7.8226c0.82666 0 1.5262-0.29146 2.0985-0.87438 0.57232-0.58292 0.86378-1.2877 0.87438-2.1144 0.010599-0.82666-0.28086-1.5262-0.87438-2.0985-0.59352-0.57232-1.293-0.86378-2.0985-0.87438-0.8055-0.010599-1.5103 0.28086-2.1144 0.87438-0.60414 0.59352-0.8956 1.293-0.87438 2.0985 0.021197 0.8055 0.31266 1.5103 0.87438 2.1144 0.56172 0.60414 1.2665 0.8956 2.1144 0.87438zm4.4695 0.2115 3.681 3.6819-1.259 1.284-3.6817-3.7 0.0019784-0.69479-0.090043-0.098846c-0.87973 0.76087-1.92 1.1413-3.1207 1.1413-1.3553 0-2.5025-0.46363-3.4417-1.3909s-1.4088-2.0686-1.4088-3.4239c0-1.3553 0.4696-2.4966 1.4088-3.4239 0.9392-0.92727 2.0864-1.3969 3.4417-1.4088 1.3553-0.011889 2.4906 0.45771 3.406 1.4088 0.9154 0.95107 1.379 2.0924 1.3909 3.4239 0 1.2126-0.38043 2.2588-1.1413 3.1385l0.098834 0.090049z"></path></svg></button></td><td class="gsc-clear-button"><div class="gsc-clear-button" title="clear results">&nbsp;</div></td></tr></tbody></table></div></form></div>
      </li>
    </ul>
  </div>
</nav><button type="button" class="to-the-top">
  <span class="sr-only">Top</span>
  <span class="fa fa-chevron-up"></span>
</button><nav class="main-nav navbar">
  <header class="nav-header">
    <a href="https://www.softwareag.cloud/site/dev-center/cumulocity-iot.html">
      <img src="https://cumulocity.com/guides/images/cumulocity-iot.svg"
        class="img-responsive no-zoom"
        alt="Cumulocity IoT">
    </a>

    <div class="dropdown">
      <button class="dropdown-toggle"
        type="button"
        id="dropdownMenuButton"
        data-toggle="dropdown"
        aria-haspopup="true"
        aria-expanded="false">
        <span id="current-dropdown-toggle" class="text-truncate"></span> <span class="caret"></span>
      </button>
      <div class="dropdown-menu"
        aria-labelledby="dropdownMenuButton">
        
        
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/release-notes/overview/'><i class="c8y-icon c8y-icon-notification"></i> Release notes</a>
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/concepts/introduction/'><i class="c8y-icon c8y-icon-c8y-data"></i> Concepts guide</a>
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/users-guide/getting-started/'><i class="c8y-icon c8y-icon-user"></i> User guide</a>
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/benutzerhandbuch/overview/'><i class="c8y-icon c8y-icon-user"></i> Handbuch</a>
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/devices/overview/'><i class="c8y-icon c8y-icon-device-management"></i> Device guides</a>
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/edge/overview/'><i class="fa fa-book"></i> Cumulocity IoT Edge</a>
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/microservice-sdk/introduction/'><i class="c8y-icon c8y-icon-tools"></i> Microservice SDK guide</a>
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/device-sdk/introduction/'><i class="c8y-icon c8y-icon-tools"></i> Device SDK guide</a>
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/web/introduction/'><i class="c8y-icon c8y-icon-smart-rest"></i> Web SDK guide</a>
        
        
        
        
        
        
        
        

        
        
        
        
        <span class="current-app">Analytics guide</span>
        
        

        <a class='dropdown-menu-item active'
          href='https://cumulocity.com/guides/apama/overview-analytics/'><i class="c8y-icon c8y-icon-data-explorer"></i> Analytics guide</a>
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/reference/rest-implementation/'><i class="fa fa-book"></i> Reference guide</a>
        
      </div>
    </div>
  </header>

  

  <nav id="main-nav"
    class="nav-sections">
    
    
    <div class="">
        
        
        
        
      <a class=""
        href="https://cumulocity.com/guides/apama/overview-analytics/">Overview</a>
     
      
    </div>
    
    
    
    <div class="">
        
        
        
        
      <a href="javascript:void(0);"
        data-toggle="collapse"
        data-target="#page-nav1"
        class="collapse-btn  collapsed ">
        <i class="fa fa-chevron-right "></i>
      </a>
      
      <a class=""
        href="https://cumulocity.com/guides/apama/analytics-introduction/">Basic functionality</a>
     
      
      
      <div id="page-nav1"
        class="collapse   ">
        <nav class="list-group nav">
          
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/analytics-introduction/#developing-apps">Developing applications</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/analytics-introduction/#deploying-apps">Deploying applications</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/analytics-introduction/#events-and-channels">Events and channels</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/analytics-introduction/#filters">Filters</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/analytics-introduction/#example">Example</a>
            
            
        </nav>
      </div>
      
    </div>
    
    
    
    <div class="">
        
        
        
        
      <a href="javascript:void(0);"
        data-toggle="collapse"
        data-target="#page-nav2"
        class="collapse-btn  collapsed ">
        <i class="fa fa-chevron-right "></i>
      </a>
      
      <a class=""
        href="https://cumulocity.com/guides/apama/actions/">Built-in actions</a>
     
      
      
      <div id="page-nav2"
        class="collapse   ">
        <nav class="list-group nav">
          
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/actions/#overview">Overview</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/actions/#querying">Querying Cumulocity data</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/actions/#invoking-http">Invoking HTTP services</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/actions/#utility-functions">Utility functions</a>
            
            
        </nav>
      </div>
      
    </div>
    
    
    
    <div class=" slot-active ">
        
        
        
        
      <a href="javascript:void(0);"
        data-toggle="collapse"
        data-target="#page-nav3"
        class="collapse-btn ">
        <i class="fa fa-chevron-right "></i>
      </a>
      
      <a class=" active "
        href="https://cumulocity.com/guides/apama/advanced/">Advanced features</a>
     
      
      
      <div id="page-nav3"
        class="collapse   show  ">
        <nav class="list-group nav">
          
          
          <a class="list-group-item"
            href="#custom-fragments">Custom fragments</a>
          
            
          
          <a class="list-group-item"
            href="#Listeners">Listeners</a>
          
            
          
          <a class="list-group-item"
            href="#own-event-types">Creating own event types</a>
          
            
          
          <a class="list-group-item"
            href="#own-actions">Creating own actions</a>
          
            
          
          <a class="list-group-item"
            href="#variables">Variables</a>
          
            
          
          <a class="list-group-item"
            href="#spawning">Spawning monitor instances and contexts</a>
          
            
        </nav>
      </div>
      
    </div>
    
    
    
    <div class="">
        
        
        
        
      <a href="javascript:void(0);"
        data-toggle="collapse"
        data-target="#page-nav4"
        class="collapse-btn  collapsed ">
        <i class="fa fa-chevron-right "></i>
      </a>
      
      <a class=""
        href="https://cumulocity.com/guides/apama/best-practices/">Best practices and guidelines</a>
     
      
      
      <div id="page-nav4"
        class="collapse   ">
        <nav class="list-group nav">
          
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/best-practices/#epl-monitors">EPL monitors</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/best-practices/#number-format">Number formats</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/best-practices/#limitations">Apama limitations in Cumulocity IoT</a>
            
            
        </nav>
      </div>
      
    </div>
    
    
    
    <div class="">
        
        
        
        
      <a href="javascript:void(0);"
        data-toggle="collapse"
        data-target="#page-nav5"
        class="collapse-btn  collapsed ">
        <i class="fa fa-chevron-right "></i>
      </a>
      
      <a class=""
        href="https://cumulocity.com/guides/apama/examples/">Examples</a>
     
      
      
      <div id="page-nav5"
        class="collapse   ">
        <nav class="list-group nav">
          
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/examples/#hourly-mean">Calculating an hourly average of measurements</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/examples/#create-alarm-2">Creating alarms from bit measurements</a>
            
            
        </nav>
      </div>
      
    </div>
    
    
    
    <div class="">
        
        
        
        
      <a href="javascript:void(0);"
        data-toggle="collapse"
        data-target="#page-nav6"
        class="collapse-btn  collapsed ">
        <i class="fa fa-chevron-right "></i>
      </a>
      
      <a class=""
        href="https://cumulocity.com/guides/apama/study/">Study: Circular geofence alarms</a>
     
      
      
      <div id="page-nav6"
        class="collapse   ">
        <nav class="list-group nav">
          
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/study/#prerequisites">Prerequisites</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/study/#step-1-html">Step 1: Filtering the input</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/study/#step-2">Step 2: Collecting necessary data</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/study/#step-3">Step 3: Checking if the device supports c8y_Geofence</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/study/#step-4">Step 4: Creating the trigger</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/study/#step-5">Step 5: Creating the alarm</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/study/#step-6">Step 6: Clearing the alarm</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/study/#putting-together">Putting everything together</a>
            
            
        </nav>
      </div>
      
    </div>
    
    
    
    
  </nav>
</nav>
<div class="cover"></div>

<div class="main-content">
  <article class="page-section">
    <header class="section-header">
      <h1 class="text-light">Advanced features</h1>
    </header>
    
      <div class="lead">
        
      </div>
      
  </article>

  
  
  
  <article id="custom-fragments" class="page-section">
    <h2>
      <button class="btn-link bookmark" data-clipboard-text="#custom-fragments">
        <span class="fa fa-link"></span>
      </button>
      Custom fragments</h2>
    <p>Cumulocity APIs give you the possibility to structure your data freely. In the Apama Event Processing Language this is done by adding entries to params, which is of the type dictionary<string,any>. Events all have a params field, which is translated to fragments or optional fields. Thus, when receiving events, look up entries in the params field. When sending events, this can be done by definining event types, or you can use dictionary<string,any> type; when receiving events, the EPL type will be dictionary<any,any>. Note that EPL is strongly typed, so if you are creating an event with no fragments, a &lsquo;new dictionary<string,any>&rsquo; expression is required. If you are providing entries inline with a dictionary literal, then EPL will determine the type based on the type of the first key and value pair - thus, for dictionary<string, any>, cast the first value to an &lsquo;any&rsquo; type with <any> cast operator:</p>

<pre><code>send Event(..., new dictionary&lt;string,any&gt;) to Event.CHANNEL;

send Event(..., {&quot;fragment&quot;:&lt;any&gt;&quot;value&quot;}) to Event.CHANNEL;
</code></pre>

<p>The MeasurementValue type is provided for the measurements in the Measurement type. MeasurementValue has value and unit, fields, and extraParams for other fragments.</p>

<p>Example 1:</p>

<pre><code>send Measurement(&quot;&quot;, &quot;c8y_TemperatureMeasurement&quot;, &quot;12345&quot;, currentTime, {
    &quot;c8y_TemperatureMeasurement&quot;:{
        &quot;T1&quot;:MeasurementValue(1.0, &quot;C&quot;, new dictionary&lt;string,any&gt;),
        &quot;T2&quot;:MeasurementValue(2.0, &quot;C&quot;, new dictionary&lt;string,any&gt;),
        &quot;T3&quot;:MeasurementValue(3.0, &quot;C&quot;, new dictionary&lt;string,any&gt;),
        &quot;T4&quot;:MeasurementValue(4.0, &quot;C&quot;, new dictionary&lt;string,any&gt;),
        &quot;T5&quot;:MeasurementValue(5.0, &quot;C&quot;, new dictionary&lt;string,any&gt;)
    }},
    new dictionary&lt;string,any&gt;) to Measurement.CREATE_CHANNEL;
</code></pre>

<p>This will result in the following JSON structure:</p>

<pre><code>{
  &quot;type&quot;: &quot;c8y_TemperatureMeasurement&quot;,
  &quot;time&quot;: &quot;...&quot;,
  &quot;source&quot;: {
    &quot;id&quot;: &quot;12345&quot;
  },
  &quot;c8y_TemperatureMeasurement&quot;: {
    &quot;T1&quot;: {
      &quot;value&quot;: 1,
      &quot;unit&quot;: &quot;C&quot;
    },
    &quot;T2&quot;: {
      &quot;value&quot;: 1,
      &quot;unit&quot;: &quot;C&quot;
    },
    &quot;T3&quot;: {
      &quot;value&quot;: 1,
      &quot;unit&quot;: &quot;C&quot;
    },
    &quot;T4&quot;: {
      &quot;value&quot;: 1,
      &quot;unit&quot;: &quot;C&quot;
    },
    &quot;T5&quot;: {
      &quot;value&quot;: 1,
      &quot;unit&quot;: &quot;C&quot;
    },
  }
}
</code></pre>

  </article>
  
  <article id="Listeners" class="page-section">
    <h2>
      <button class="btn-link bookmark" data-clipboard-text="#Listeners">
        <span class="fa fa-link"></span>
      </button>
      Listeners</h2>
    

<p>Triggering a statement by an arriving event is not the only possibility. The following sections cover other ways to combine listeners. Refer to the Apama documentation for full details - see the <a href="http://www.apamacommunity.com/documents/10.1.0.3/apama_10.1.0.3_webhelp/apama-webhelp/#page/apama-webhelp%252Fco-DevApaAppInEpl_defining_event_listeners.html%2523">Defining Event Listeners</a> topic.</p>

<h3 id="filters">Filters</h3>

<p>Filters enable you to trigger by combinations or sequences of other triggers. If you have a trigger like this</p>

<pre><code>on all Event() as e { .. }
</code></pre>

<p>it is also possible to add filters in the pattern.</p>

<pre><code>on all Event(type = &quot;c8y_EntranceEvent&quot;) as e { }
</code></pre>

<p>You can listen for more than one event:</p>

<pre><code>on Event() as e and Alarm() as m { .. }
</code></pre>

<p>This will trigger on receiving an Event and an Alarm event - the first of each will be captured.</p>

<p>You can also trigger by sequences.</p>

<pre><code>on all (Event() as e -&gt; Alarm() as m) { .. }
</code></pre>

<p>This will trigger for every pair Event followed by Alarm. On receiving an Event, it will stop listening for further events and start listening for alarms instead. Once an Alarm is received, it will start listening for events again.</p>

<h3 id="timers">Timers</h3>

<p>You can also trigger listeners based on time. You can either trigger in a certain interval, for example, fire every 5 minutes (300 seconds):</p>

<pre><code>on all wait(300.0) { .. }
</code></pre>

<p>Or you can have a listener fire at certain times of the day, with similar functionality to Unix&rsquo;s cron scheduler:</p>

<pre><code>// timer:at(minutes, hours, daysOfMonth, month, daysOfWeek, (optional) seconds)
// minutes: 0-59
// hours: 0-23
// daysOfMonth: 1-31
// month: 1-12
// daysOfWeek: 0 (Sunday) - 6 (Saturday)
// seconds: 0-59

on all at(*, *, *, *, *) {} // trigger every minute

on at(*/10, *, *, *, *) {} // trigger every 10 minutes
on at(0, 1, *, *, [1,3,5]) {} // trigger at 1am every monday, wednesday and friday
on at(0, */2, (1-7), *, *) {} // trigger every 2 hours on every day in the first week of every month
</code></pre>

<p>You can also combine timer patterns with other patterns. For example, you can check if there was an event within a certain time after another event:</p>

<pre><code>on Event() -&gt; wait(600.0)  and not Alarm() { .. }
</code></pre>

<p>This will trigger if there is an Event and within 10 minutes there is no Alarm. Note the use of &ldquo;not&rdquo; which terminates the listener if the event occurs.</p>

<h3 id="streams-windows">Streams - windows</h3>

<p>Streams give you the possibility to operate on windows of events. Streams use the &ldquo;from&rdquo; keyword instead of &ldquo;on&rdquo; and define a window to operate over, and select what output they want from that window using aggregates. Windows can be restricted by two means:</p>

<ol>
<li><p>Windows for a certain time - use the &ldquo;within&rdquo; keyword.</p>

<pre><code>from m in all Measurement(type = &quot;c8y_TemperatureMeasurement&quot;) within 3600.0 select avg(m.measurements[&quot;c8y_TemperatureMeasurement&quot;][&quot;T&quot;].value) as avgValue { }
</code></pre></li>

<li><p>Windows with a certain amount of events - use the &ldquo;retain&rdquo; keyword.</p>

<pre><code>from m in all Measurement(type = &quot;c8y_TemperatureMeasurement&quot;) retain 100 select avg(m.measurements[&quot;c8y_TemperatureMeasurement&quot;][&quot;T&quot;].value) as avgValue { }
</code></pre></li>
</ol>

<h3 id="streams-outputting-periodically">Streams - outputting periodically</h3>

<p>Streams can also control how frequently they evaluate, using the <code>&quot;every</code>&rdquo; specifier.</p>

<pre><code>// will output the last measurement arrived every 1 minute
from m in all Measurement(type = &quot;c8y_TemperatureMeasurement&quot;) within 60.0 every 60.0 select last(m.measurements[&quot;c8y_TemperatureMeasurement&quot;][&quot;T&quot;].value) as lastValue {  }

// will output the first of every 20 measurements arriving
from m in all Measurement(type = &quot;c8y_TemperatureMeasurement&quot;) retain 20 every 20 select first(m.measurements[&quot;c8y_TemperatureMeasurement&quot;][&quot;T&quot;].value) as firstValue { }

// will output average of all 20 measurements after the 20th arrived
from m in all Measurement(type = &quot;c8y_TemperatureMeasurement&quot;) retain 20 every 20 select avg(m.measurements[&quot;c8y_TemperatureMeasurement&quot;][&quot;T&quot;].value) as avgValue { }
</code></pre>

<p>See the Apama documentation for <a href="http://www.apamacommunity.com/documents/10.1.0.3/apama_10.1.0.3_webhelp/apama-webhelp/#page/apama-webhelp%252Fre-ApaEplRef_built_in_aggregate_functions.html">built-in aggregates</a>.</p>

  </article>
  
  <article id="own-event-types" class="page-section">
    <h2>
      <button class="btn-link bookmark" data-clipboard-text="#own-event-types">
        <span class="fa fa-link"></span>
      </button>
      Creating own event types</h2>
    <p>As well as the predefined event types, you can define your own event types. These can be useful to detect patterns of events occurring which trigger other parts of the same module.</p>

<pre><code>event MyEvent {
    Measurement m1;
    Measurement m2;
}

...

on Measurement() as m1 -&gt; Measurement() as m2 {
    route MyEvent(m1, m2);
}
</code></pre>

<blockquote>
<p><strong>Info:</strong> Cumulocity deploys each module into its own namespace, so event definitions from one module cannot be used in other modules. This prevents dependencies between modules.</p>
</blockquote>

  </article>
  
  <article id="own-actions" class="page-section">
    <h2>
      <button class="btn-link bookmark" data-clipboard-text="#own-actions">
        <span class="fa fa-link"></span>
      </button>
      Creating own actions</h2>
    <p>Typically you will structure a monitor using actions (much like functions in Java).</p>

<p>Examples:</p>

<p>Increasing the given severity:</p>

<pre><code>action upgradeSeverity(string old) returns string {
        if old = &quot;WARNING&quot; { return &quot;MINOR&quot;; }
        if old = &quot;MINOR&quot;   { return &quot;MAJOR&quot;; }
        if old = &quot;MAJOR&quot;   { return &quot;CRITICAL&quot;; }
        return old;
    }
</code></pre>

<p>Calculating the distance between two geo-coordinates:</p>

<pre><code>action distance(float lat1, float lon1, float lat2, float lon2) returns float {
    float R := 6371000.0;
    float toRad := float.PI / 180.0;
    float lat1Rad := lat1 * toRad;
    float lat2Rad := lat2 * toRad;
    float deltaLatRad := (lat2-lat1) * toRad;
    float deltaLonRad := (lat2-lat1) * toRad;
    float a := (deltaLatRad/2.0).sin().pow(2.0) * lat1Rad.cos() * lat2Rad.cos() * (deltaLonRad/2.0).sin().pow(2.0);
    float c := 2.0 * a.sqrt().atan2((1.0-a).sqrt());
    return R * c;
}
</code></pre>

  </article>
  
  <article id="variables" class="page-section">
    <h2>
      <button class="btn-link bookmark" data-clipboard-text="#variables">
        <span class="fa fa-link"></span>
      </button>
      Variables</h2>
    <p>You can define variables in your modules.</p>

<pre><code>string myEmailText := &quot;Hello World&quot;;
sequence&lt;string&gt; supportedOperationsList := [&quot;c8y_Restart&quot;, &quot;c8y_Relay&quot;];
</code></pre>

<p>If you define a monitor-scope variable (that is, inside a monitor but not within any actions on that monitor), then that can be used in a listener if you use a colon (:) instead of &ldquo;as&rdquo; for the event coassignment in the listener. Thus the below sends the latest event every 10 seconds:</p>

<pre><code>monitor MyMonitor {
    // monitor scope:
    Event e;
    action onload() {
        on all Event():e {}
        on all wait(10.0) {
            emit e to Event.CHANNEL;
        }
    }
}
</code></pre>

<p>When a listener starts, it takes a copy of all of the local variables. The below example thus sends each event after a 10 second delay, even if other events come in between.</p>

<pre><code>monitor MyMonitor {
    // monitor scope:
    Event e;
    action onload() {
        on all Event():e {
            on all wait(10.0) {
                emit e to Event.CHANNEL;
            }
        }
    }
}
</code></pre>

  </article>
  
  <article id="spawning" class="page-section">
    <h2>
      <button class="btn-link bookmark" data-clipboard-text="#spawning">
        <span class="fa fa-link"></span>
      </button>
      Spawning monitor instances and contexts</h2>
    <p>While it is possible to handle multiple devices in a single monitor (for example, using <code>group by</code> and <code>partition by</code> in streams, or maintaining a dictionary keyed on the device ID for other state), it is often useful to separate processing of different devices into separate monitor instances.</p>

<p>New monitor instances can be created using the <code>spawn</code> statement. This takes a copy of the monitor&rsquo;s monitor scope variables and runs the named action in a new monitor instance. No listeners are copied into the new monitor. It is also possible to specify a context to spawn the new monitor instance in. Different contexts can run concurrently with each other, and also help isolate different monitors from each other. When constructing a context, supply a name to identify the context, and a boolean to control if the context is public - that is, it receives the Cumulocity events by default (sent to the default channel).</p>

<p>This pattern is often used with the unmatched keyword to identify events that are not matched by any other listeners in that context; by using a separate context for each monitor, the unmatched behavior is scoped to that monitor. For example:</p>

<pre><code>monitor PerDeviceMeasurementTracker {
    action onload() {
        spawn factory to context(&quot;PerDeviceMeasurementTracker&quot;, true);
    }
    action factory() {
        on all unmatched Measurement() as m {
            spawn perDevice(m);
        }
    }

    dictionary&lt;string, Measurement&gt; latestMeasurementByType; // measurements for this device

    action perDevice(Measurement m) {
        processMeasurement(m);
        on all Measurement(source = m.source) as m {
            processMeasurement(m);
        }
    }
    action processMeasurement(Measurement m) {
        latestMeasurementByType[m.type] := m;
    }
}
</code></pre>

  </article>
  
  
</div>
<footer class="main-footer">
  <div class="copyright">
    <div class="container text-center">
      <p class="small ">&copy; 2019 Cumulocity GmbH | All rights reserved.</p>
    </div>
  </div>  
</footer>

<!-- Essential Scripts -->

<!-- jQuery -->
<script src="https://cumulocity.com/guides/js/vendor/jquery.min.js"></script>
<script src="https://cumulocity.com/guides/js/vendor/bootstrap.bundle.min.js"></script>
<script src="https://cumulocity.com/guides/js/vendor/clipboard.js"></script>
<script src="https://cumulocity.com/guides/js/vendor/zoom.js"></script>
<script src="https://cumulocity.com/guides/js/vendor/highlight.min.js"></script>
<script src="https://cumulocity.com/guides/js/main.js"></script>





    
   
  </body>
</html>
