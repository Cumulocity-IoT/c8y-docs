<!DOCTYPE html>
<html>
<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <base href="" />
    <meta name="generator" content="Hugo 0.54.0 with theme C8yDocs">
    <title>Study: Circular geofence alarms - Cumulocity IoT Guides</title>
    <meta name="author" content="Carlos Ceia @ Cumulocity">
    <meta name="keywords" content=", Software AG Cloud, Cumulocity IoT, Internet of things, analytics, devices, connect">


    <link rel="icon" href="/favicon.ico">

    

    

    
    
    
    <link rel="stylesheet" href="https://cumulocity.com/guides/style.css">
    

      
      <script> window.zEmbed||function(e,t){var n,o,d,i,s,a=[],r=document.createElement("iframe");window.zEmbed=function(){a.push(arguments)},window.zE=window.zE||window.zEmbed,r.src="javascript:false",r.title="",r.role="presentation",(r.frameElement||r).style.cssText="display: none",d=document.getElementsByTagName("script"),d=d[d.length-1],d.parentNode.insertBefore(r,d),i=r.contentWindow,s=i.document;try{o=s}catch(c){n=document.domain,r.src='javascript:var d=document.open();d.domain="'+n+'";void(0);',o=s}o.open()._l=function(){var o=this.createElement("script");n&&(this.domain=n),o.id="js-iframe-async",o.src=e,this.t=+new Date,this.zendeskHost=t,this.zEQueue=a,this.body.appendChild(o)},o.write('<body onload="document._l();">'),o.close()}("https://assets.zendesk.com/embeddable_framework/main.js","cumulocity.zendesk.com"); </script>
        <script type="text/JavaScript">
          window.zESettings = {
            webWidget: {
              color: {
                theme: '#1776bf'    
              },
              position: {
                horizontal: 'right',
                vertical: 'top'     
              }
            }
          };
          </script>
        
        
   
  </head><body data-spy="scroll" data-target="#main-nav" ><button type="button" class="sidebar-toggle">
  <span class="icon-bar"></span>
  <span class="icon-bar"></span>
  <span class="icon-bar"></span>
  <span>MENU</span>
</button>
<nav class="main-top-bar" >
  <div class="d-flex container">
    <ul class="nav d-flex flex-start hidden-xs nav-left">
      <li><a href="https://www.softwareag.cloud/site/product/cumulocity-iot.html">Cumulocity IoT</a></li>
      <li><a href="http://resources.cumulocity.com/documentation/jssdk/latest/#/api">Cumulocity Angular API</a></li>
    </ul>
    <ul class="nav flex-end nav-right">
      <li>   <script>
              (function() {
                var cx = '008969372384807682938:yeh7xt785g4';
                var gcse = document.createElement('script');
                gcse.type = 'text/javascript';
                gcse.async = true;
                gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(gcse, s);
              })();
            </script>
        <div id="___gcse_0" dir="ltr"><form class="gsc-search-box gsc-search-box-tools" accept-charset="utf-8"><div class="table-responsive"><table cellspacing="0" cellpadding="0" class="gsc-search-box"><tbody><tr><td class="gsc-input"><div class="gsc-input-box" id="gsc-iw-id1"><table cellspacing="0" cellpadding="0" id="gs_id50" class="gstl_50 gsc-input" style="width: 100%; padding: 0px;"><tbody><tr><td id="gs_tti50" class="gsib_a"><input autocomplete="off" type="text" size="10" class="gsc-input" name="search" title="search" id="gsc-i-id1" placeholder="Custom Search" dir="ltr" spellcheck="false" x-webkit-grammar="builtin:search" lang="en" style="width: 100%; padding: 0px; border: none; margin: -0.0625em 0px 0px; height: 1.25em; background: url(&quot;https://www.google.com/cse/static/images/1x/googlelogo_lightgrey_46x16dp.png&quot;) left center no-repeat rgb(255, 255, 255); text-indent: 48px; outline: none;"></td><td class="gsib_b"><div class="gsst_b" id="gs_st50" dir="ltr"><a class="gsst_a" href="javascript:void(0)" style="display: none;" title="Clear search box" role="button"><span class="gscb_a" id="gs_cb50" aria-hidden="true">Ã—</span></a></div></td></tr></tbody></table></div></td><td class="gsc-search-button"><button class="gsc-search-button gsc-search-button-v2"><svg width="13" height="13" viewBox="0 0 13 13"><title>search</title><path d="m4.8495 7.8226c0.82666 0 1.5262-0.29146 2.0985-0.87438 0.57232-0.58292 0.86378-1.2877 0.87438-2.1144 0.010599-0.82666-0.28086-1.5262-0.87438-2.0985-0.59352-0.57232-1.293-0.86378-2.0985-0.87438-0.8055-0.010599-1.5103 0.28086-2.1144 0.87438-0.60414 0.59352-0.8956 1.293-0.87438 2.0985 0.021197 0.8055 0.31266 1.5103 0.87438 2.1144 0.56172 0.60414 1.2665 0.8956 2.1144 0.87438zm4.4695 0.2115 3.681 3.6819-1.259 1.284-3.6817-3.7 0.0019784-0.69479-0.090043-0.098846c-0.87973 0.76087-1.92 1.1413-3.1207 1.1413-1.3553 0-2.5025-0.46363-3.4417-1.3909s-1.4088-2.0686-1.4088-3.4239c0-1.3553 0.4696-2.4966 1.4088-3.4239 0.9392-0.92727 2.0864-1.3969 3.4417-1.4088 1.3553-0.011889 2.4906 0.45771 3.406 1.4088 0.9154 0.95107 1.379 2.0924 1.3909 3.4239 0 1.2126-0.38043 2.2588-1.1413 3.1385l0.098834 0.090049z"></path></svg></button></td><td class="gsc-clear-button"><div class="gsc-clear-button" title="clear results">&nbsp;</div></td></tr></tbody></table></div></form></div>
      </li>
    </ul>
  </div>
</nav><button type="button" class="to-the-top">
  <span class="sr-only">Top</span>
  <span class="fa fa-chevron-up"></span>
</button><nav class="main-nav navbar">
  <header class="nav-header">
    <a href="https://www.softwareag.cloud/site/dev-center/cumulocity-iot.html">
      <img src="https://cumulocity.com/guides/images/cumulocity-iot.svg"
        class="img-responsive no-zoom"
        alt="Cumulocity IoT">
    </a>

    <div class="dropdown">
      <button class="dropdown-toggle"
        type="button"
        id="dropdownMenuButton"
        data-toggle="dropdown"
        aria-haspopup="true"
        aria-expanded="false">
        <span id="current-dropdown-toggle" class="text-truncate"></span> <span class="caret"></span>
      </button>
      <div class="dropdown-menu"
        aria-labelledby="dropdownMenuButton">
        
        
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/release-notes/overview/'><i class="c8y-icon c8y-icon-notification"></i> Release notes</a>
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/concepts/introduction/'><i class="c8y-icon c8y-icon-c8y-data"></i> Concepts guide</a>
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/users-guide/getting-started/'><i class="c8y-icon c8y-icon-user"></i> User guide</a>
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/benutzerhandbuch/overview/'><i class="c8y-icon c8y-icon-user"></i> Handbuch</a>
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/devices/overview/'><i class="c8y-icon c8y-icon-device-management"></i> Device guides</a>
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/edge/overview/'><i class="fa fa-book"></i> Cumulocity IoT Edge</a>
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/microservice-sdk/introduction/'><i class="c8y-icon c8y-icon-tools"></i> Microservice SDK guide</a>
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/device-sdk/introduction/'><i class="c8y-icon c8y-icon-tools"></i> Device SDK guide</a>
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/web/introduction/'><i class="c8y-icon c8y-icon-smart-rest"></i> Web SDK guide</a>
        
        
        
        
        
        
        
        

        
        
        
        
        <span class="current-app">Analytics guide</span>
        
        

        <a class='dropdown-menu-item active'
          href='https://cumulocity.com/guides/apama/overview-analytics/'><i class="c8y-icon c8y-icon-data-explorer"></i> Analytics guide</a>
        
        
        
        
        
        
        
        

        
        
        

        <a class='dropdown-menu-item '
          href='https://cumulocity.com/guides/reference/rest-implementation/'><i class="fa fa-book"></i> Reference guide</a>
        
      </div>
    </div>
  </header>

  

  <nav id="main-nav"
    class="nav-sections">
    
    
    <div class="">
        
        
        
        
      <a class=""
        href="https://cumulocity.com/guides/apama/overview-analytics/">Overview</a>
     
      
    </div>
    
    
    
    <div class="">
        
        
        
        
      <a href="javascript:void(0);"
        data-toggle="collapse"
        data-target="#page-nav1"
        class="collapse-btn  collapsed ">
        <i class="fa fa-chevron-right "></i>
      </a>
      
      <a class=""
        href="https://cumulocity.com/guides/apama/analytics-introduction/">Basic functionality</a>
     
      
      
      <div id="page-nav1"
        class="collapse   ">
        <nav class="list-group nav">
          
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/analytics-introduction/#developing-apps">Developing applications</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/analytics-introduction/#deploying-apps">Deploying applications</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/analytics-introduction/#events-and-channels">Events and channels</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/analytics-introduction/#filters">Filters</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/analytics-introduction/#example">Example</a>
            
            
        </nav>
      </div>
      
    </div>
    
    
    
    <div class="">
        
        
        
        
      <a href="javascript:void(0);"
        data-toggle="collapse"
        data-target="#page-nav2"
        class="collapse-btn  collapsed ">
        <i class="fa fa-chevron-right "></i>
      </a>
      
      <a class=""
        href="https://cumulocity.com/guides/apama/actions/">Built-in actions</a>
     
      
      
      <div id="page-nav2"
        class="collapse   ">
        <nav class="list-group nav">
          
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/actions/#overview">Overview</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/actions/#querying">Querying Cumulocity data</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/actions/#invoking-http">Invoking HTTP services</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/actions/#utility-functions">Utility functions</a>
            
            
        </nav>
      </div>
      
    </div>
    
    
    
    <div class="">
        
        
        
        
      <a href="javascript:void(0);"
        data-toggle="collapse"
        data-target="#page-nav3"
        class="collapse-btn  collapsed ">
        <i class="fa fa-chevron-right "></i>
      </a>
      
      <a class=""
        href="https://cumulocity.com/guides/apama/advanced/">Advanced features</a>
     
      
      
      <div id="page-nav3"
        class="collapse   ">
        <nav class="list-group nav">
          
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/advanced/#custom-fragments">Custom fragments</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/advanced/#Listeners">Listeners</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/advanced/#own-event-types">Creating own event types</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/advanced/#own-actions">Creating own actions</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/advanced/#variables">Variables</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/advanced/#spawning">Spawning monitor instances and contexts</a>
            
            
        </nav>
      </div>
      
    </div>
    
    
    
    <div class="">
        
        
        
        
      <a href="javascript:void(0);"
        data-toggle="collapse"
        data-target="#page-nav4"
        class="collapse-btn  collapsed ">
        <i class="fa fa-chevron-right "></i>
      </a>
      
      <a class=""
        href="https://cumulocity.com/guides/apama/best-practices/">Best practices and guidelines</a>
     
      
      
      <div id="page-nav4"
        class="collapse   ">
        <nav class="list-group nav">
          
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/best-practices/#epl-monitors">EPL monitors</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/best-practices/#number-format">Number formats</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/best-practices/#limitations">Apama limitations in Cumulocity IoT</a>
            
            
        </nav>
      </div>
      
    </div>
    
    
    
    <div class="">
        
        
        
        
      <a href="javascript:void(0);"
        data-toggle="collapse"
        data-target="#page-nav5"
        class="collapse-btn  collapsed ">
        <i class="fa fa-chevron-right "></i>
      </a>
      
      <a class=""
        href="https://cumulocity.com/guides/apama/examples/">Examples</a>
     
      
      
      <div id="page-nav5"
        class="collapse   ">
        <nav class="list-group nav">
          
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/examples/#hourly-mean">Calculating an hourly average of measurements</a>
            
            
          
            <a class="list-group-item"
              href="https://cumulocity.com/guides/apama/examples/#create-alarm-2">Creating alarms from bit measurements</a>
            
            
        </nav>
      </div>
      
    </div>
    
    
    
    <div class=" slot-active ">
        
        
        
        
      <a href="javascript:void(0);"
        data-toggle="collapse"
        data-target="#page-nav6"
        class="collapse-btn ">
        <i class="fa fa-chevron-right "></i>
      </a>
      
      <a class=" active "
        href="https://cumulocity.com/guides/apama/study/">Study: Circular geofence alarms</a>
     
      
      
      <div id="page-nav6"
        class="collapse   show  ">
        <nav class="list-group nav">
          
          
          <a class="list-group-item"
            href="#prerequisites">Prerequisites</a>
          
            
          
          <a class="list-group-item"
            href="#step-1-html">Step 1: Filtering the input</a>
          
            
          
          <a class="list-group-item"
            href="#step-2">Step 2: Collecting necessary data</a>
          
            
          
          <a class="list-group-item"
            href="#step-3">Step 3: Checking if the device supports c8y_Geofence</a>
          
            
          
          <a class="list-group-item"
            href="#step-4">Step 4: Creating the trigger</a>
          
            
          
          <a class="list-group-item"
            href="#step-5">Step 5: Creating the alarm</a>
          
            
          
          <a class="list-group-item"
            href="#step-6">Step 6: Clearing the alarm</a>
          
            
          
          <a class="list-group-item"
            href="#putting-together">Putting everything together</a>
          
            
        </nav>
      </div>
      
    </div>
    
    
    
    
  </nav>
</nav>
<div class="cover"></div>

<div class="main-content">
  <article class="page-section">
    <header class="section-header">
      <h1 class="text-light">Study: Circular geofence alarms</h1>
    </header>
    
      <div class="lead">
        <p>This section will give an in-depth example how you can create more complex rules. It will use multiple of the features explained before in the other sections of this guide.</p>

<p>If you are just starting with the Apama Event Processing Language please take a look at <a href="http://cumulocity.com/guides/apama/examples"><span class="inline-comment-marker" data-ref="039df6be-3966-4270-80ad-14af1e16088a">these examples</span></a><span class="inline-comment-marker" data-ref="039df6be-3966-4270-80ad-14af1e16088a">.</span></p>

      </div>
      
  </article>

  
  
  
  <article id="prerequisites" class="page-section">
    <h2>
      <button class="btn-link bookmark" data-clipboard-text="#prerequisites">
        <span class="fa fa-link"></span>
      </button>
      Prerequisites</h2>
    

<h3 id="goal">Goal</h3>

<p>We want our tracking devices that are continuously sending location events to automatically generate alarms if they move outside a geofence. This geofence will be a circle and should be configurable for each device separately. The alarm will be created at the moment the device moves outside the geofence. While it is moving outside, it should not create new alarms because the first one will remain active. As soon as the device moves back into the geofence, the alarm will be cleared.</p>

<h3 id="cumulocity-data-model">Cumulocity data model</h3>

<p>Location event structure (the part we need):</p>

<pre><code>{
  &quot;id&quot;: &quot;...&quot;,
  &quot;source&quot;: { &quot;id&quot;: &quot;...&quot;, },
  &quot;text&quot;: &quot;...&quot;,
  &quot;time&quot;: &quot;...&quot;,
  &quot;type&quot;: &quot;...&quot;,
  &quot;c8y_Position&quot;: { &quot;alt&quot;: ..., &quot;lng&quot;: ..., &quot;lat&quot;: ... }

}
</code></pre>

<p>We store the geofence configuration in the device (the radius will be configured in meters):</p>

<pre><code>{
  &quot;c8y_Geofence&quot;: { &quot;lat&quot;: ..., &quot;lng&quot;: ..., &quot;radius&quot;: ... }

}
</code></pre>

<p>Additionally, we want to enable/disable the geofence alarms for each device without removing the configuration entirely. We will do that by adding/removing &ldquo;c8y_Geofence&rdquo; to c8y_SupportedOperations in the device:</p>

<pre><code>{
  &quot;c8y_SupportedOperations&quot;: [..., &quot;c8y_Geofence&quot;, ...]

}
</code></pre>

<h3 id="calculation">Calculation</h3>

<p>The device is outside of the geofence if the distance between the current position and the center is bigger than the configured radius of the geofence. What we need is a function that can calculate the difference between <span class="inline-comment-marker" data-ref="e33a99eb-b07c-4c46-9e16-2e6ae6d54ffe">two</span> geo-coordinates:</p>

<pre><code>action distance(float lat1, float lon1, float lat2, float lon2) returns float {
        float R := 6371000.0;
        float toRad := float.PI / 180.0;
        float lat1Rad := lat1 * toRad;
        float lat2Rad := lat2 * toRad;
        float deltaLatRad := (lat2-lat1) * toRad;
        float deltaLonRad := (lat2-lat1) * toRad;
        float a := (deltaLatRad/2.0).sin().pow(2.0) * lat1Rad.cos() * lat2Rad.cos() * (deltaLonRad/2.0).sin().pow(2.0);
        float c := 2.0 * a.sqrt().atan2((1.0-a).sqrt());
        return R * c;
    }
</code></pre>

<p>The above action will return the distance in meters.</p>

  </article>
  
  <article id="step-1-html" class="page-section">
    <h2>
      <button class="btn-link bookmark" data-clipboard-text="#step-1-html">
        <span class="fa fa-link"></span>
      </button>
      Step 1: Filtering the input</h2>
    <p>The main input for this module will be events. To discard non-matching events as early as possible, we perform this as the first check in the listener:</p>

<pre><code>on all Event() as e {
            if e.params.hasKey(&quot;c8y_Position&quot;) {
                // we have an event
            }
        }
</code></pre>

  </article>
  
  <article id="step-2" class="page-section">
    <h2>
      <button class="btn-link bookmark" data-clipboard-text="#step-2">
        <span class="fa fa-link"></span>
      </button>
      Step 2: Collecting necessary data</h2>
    <p>In the next step, we need the configuration of the geofence for the calculation and grab it.</p>

<pre><code>monitor.subscribe(FindManagedObjectResponse.CHANNEL);
...
                integer reqId := integer.getUnique();
                    send FindManagedObject(reqId, e.source, new dictionary&lt;string,string&gt;) to
                        FindManagedObject.CHANNEL;
                        on FindManagedObjectResponse(reqId = reqId) as resp 
                            and not FindManagedObjectResponseAck(reqId) {

                   ManagedObject dev := resp.managedObject;
</code></pre>

  </article>
  
  <article id="step-3" class="page-section">
    <h2>
      <button class="btn-link bookmark" data-clipboard-text="#step-3">
        <span class="fa fa-link"></span>
      </button>
      Step 3: Checking if the device supports c8y_Geofence</h2>
    <p>With the device available we will now check if there is a geofence configured for the device and if it is activated (contains &ldquo;c8y&#95;Geofence&rdquo; in supportedOperations). To check the c8y&#95;SupportedOperations array, we can use the indexOf() function. This function will loop through all elements and return the index of that entry, or a negative number if the value is not present. For the configuration, we will just check if the device contains the fragment &ldquo;c8y&#95;Geofence&rdquo;.</p>

<p>Once we have an event and a device, we extract the data from the event&rsquo;s c8y&#95;Position and the device&rsquo;s c8y&#95;Geofence. These objects are mapped to dictionary<any,any> entries in the params. As the params hold values of type &ldquo;any&rdquo;, we need to cast to a dictionary&lt;;any,any&gt;:</p>

<pre><code>    if(dev.params.hasKey(&quot;c8y_Geofence&quot;) and
       dev.supportedOperations.indexOf(&quot;c8y_Geofence&quot;) &gt;= 0) {
        dictionary&lt;any,any&gt; evtPos := &lt;dictionary&lt;any, any&gt; &gt; e.params[&quot;c8y_Position&quot;];
        float eventLat := &lt;float&gt; evtPos[&quot;lat&quot;];
        float eventLng := &lt;float&gt; evtPos[&quot;lng&quot;];
    }

    dictionary&lt;any,any&gt; devGeofence := &lt;dictionary&lt;any,any&gt; &gt; dev.params[&quot;c8y_Geofence&quot;];
    float centerLat := &lt;float&gt; devGeofence[&quot;lat&quot;];
    float centerLng := &lt;float&gt; devGeofence[&quot;lng&quot;];
    float maxDistance := &lt;float&gt; devGeofence[&quot;radius&quot;];
</code></pre>

  </article>
  
  <article id="step-4" class="page-section">
    <h2>
      <button class="btn-link bookmark" data-clipboard-text="#step-4">
        <span class="fa fa-link"></span>
      </button>
      Step 4: Creating the trigger</h2>
    <p>As mentioned earlier, the device is outside of the fence if the distance between the current device position and the geofence center is bigger than the configured geofence radius. To trigger the alarm, we need 2 events so we can check if the device entered or left the geofence within these two events.</p>

<p>In the first step, we calculate the distance with the function mentioned earlier:</p>

<pre><code>float d := distance(centerLat, centerLng, eventLat, eventLng);
</code></pre>

<p>Now we re-route this as an event with:</p>

<pre><code>event LocationEventWithDistance {
        string source;
        float distance;
        Event e;
        float maxDistance;
    }

...

                        route LocationEventWithDistance(e.source, d, e, maxDistance);
</code></pre>

<p>We place the source in the event so we can easily match it in a listener.</p>

<p>We now set up a listener triggered by event LocationEventWithDistance, listening for the next LocationEventWithDistance - for the same source:</p>

<pre><code>        on all LocationEventWithDistance() as firstPos {
            on LocationEventWithDistance(source = firstPos.source) as secondPos {
                // now have two events with distances
            }
        }
</code></pre>

<p>This pair of LocationEventWithDistance events now holds all data for checking if we should create the alarm or not. Note that we are filtering the secondPos event to be for the same source as the first - there will be an active listener for every device we have received an event from.</p>

  </article>
  
  <article id="step-5" class="page-section">
    <h2>
      <button class="btn-link bookmark" data-clipboard-text="#step-5">
        <span class="fa fa-link"></span>
      </button>
      Step 5: Creating the alarm</h2>
    <p>To create the alarm, we now need two events where the first one has a distance smaller than the radius and the second one has a distance bigger than the radius. This would mean that the device just left the geofence.</p>

<pre><code>    if firstPos.distance &lt;= firstPos.maxDistance and
       secondPos.distance &gt; secondPos.maxDistance {
        send Alarm(&quot;&quot;, &quot;c8y_GeofenceAlarm&quot;, firstPos.source, currentTime,
                   &quot;Device moved out of circular geofence&quot;,
                   &quot;ACTIVE&quot;, &quot;MAJOR&quot;, 1, new dictionary&lt;string,any&gt;) to Alarm.CHANNEL;
}
</code></pre>

  </article>
  
  <article id="step-6" class="page-section">
    <h2>
      <button class="btn-link bookmark" data-clipboard-text="#step-6">
        <span class="fa fa-link"></span>
      </button>
      Step 6: Clearing the alarm</h2>
    <p>To clear the alarm, we just need to switch the condition at the bottom and additionally grab the currently active alarm to get its ID. We do not need to care about whether there is an existing alarm at this point. If there is none the listener will trigger the &ldquo;and not FindAlarmResponseAck&rdquo;, terminating the listener:</p>

<pre><code>monitor.subscribe(FindAlarmResponse.CHANNEL);
...
        if firstPos.distance &gt; firstPos.maxDistance and secondPos.distance &lt;= secondPos.maxDistance {
            integer reqId:= integer.getUnique();
            send FindAlarm(reqId, {&quot;source&quot;:firstPos.source,
                           &quot;status&quot;:&quot;ACTIVE&quot;,&quot;type&quot;:&quot;c8y_GeofenceAlarm&quot;}) to FindAlarm.CHANNEL;
            on FindAlarmResponse(reqId = reqId) as alarmResponse
               and not FindAlarmResponseAck(reqId=reqId) {
                send Alarm(alarmResponse.id, &quot;c8y_GeofenceAlarm&quot;,
                           firstPos.source, currentTime, &quot;Device moved back into circular geofence&quot;,
                           &quot;CLEARED&quot;, &quot;MAJOR&quot;, 1, new dictionary&lt;string, any&gt;) to Alarm.CHANNEL;
            }
        }
</code></pre>

  </article>
  
  <article id="putting-together" class="page-section">
    <h2>
      <button class="btn-link bookmark" data-clipboard-text="#putting-together">
        <span class="fa fa-link"></span>
      </button>
      Putting everything together</h2>
    <p>We can now combine all the parts into one module. The order of the listeners does not matter.</p>

<pre><code>using com.apama.cumulocity.ManagedObject;
using com.apama.cumulocity.Event;
using com.apama.cumulocity.Alarm;
using com.apama.cumulocity.FindAlarm;
using com.apama.cumulocity.FindAlarmResponse;
using com.apama.cumulocity.FindAlarmResponseAck;
using com.apama.cumulocity.FindManagedObject;
using com.apama.cumulocity.FindManagedObjectResponse;
using com.apama.cumulocity.FindManagedObjectResponseAck;


monitor MonitorDevicesForCircularGeofence {
    event LocationEventWithDistance {
        string source;
        float distance;
        Event e;
        float maxDistance;
    }

    action onload() {
        monitor.subscribe(FindManagedObjectResponse.CHANNEL);
        monitor.subscribe(FindAlarmResponse.CHANNEL);
        monitor.subscribe(Measurement.CHANNEL);
        on all Event() as e {
            if e.params.hasKey(&quot;c8y_Position&quot;) {
                integer reqId := integer.getUnique();
                send FindManagedObject(reqId, e.source, new dictionary&lt;string,string&gt;) to
                     FindManagedObject.CHANNEL;
                on FindManagedObjectResponse(reqId = reqId) as resp
                   and not FindManagedObjectResponseAck(reqId) {
                    ManagedObject dev := resp.managedObject;
                    if(dev.params.hasKey(&quot;c8y_Geofence&quot;) and 
                       dev.supportedOperations.indexOf(&quot;c8y_Geofence&quot;) &gt;= 0) {
                        dictionary&lt;any,any&gt; evtPos := &lt;dictionary&lt;any,any&gt; &gt; e.params[&quot;c8y_Position&quot;];
                        float eventLat := &lt;float&gt; evtPos[&quot;lat&quot;];
                        float eventLng := &lt;float&gt; evtPos[&quot;lng&quot;];

                        dictionary&lt;any,any&gt; devGeofence := &lt;dictionary&lt;any,any&gt; &gt; dev.params[&quot;c8y_Geofence&quot;];
                        float centerLat := &lt;float&gt; devGeofence[&quot;lat&quot;];
                        float centerLng := &lt;float&gt; devGeofence[&quot;lng&quot;];
                        float maxDistance := &lt;float&gt; devGeofence[&quot;radius&quot;];

                        float d := distance(centerLat, centerLng, eventLat, eventLng);
                        route LocationEventWithDistance(e.source, d, e, maxDistance);
                    }
                }
            }
        }
        on all LocationEventWithDistance() as firstPos {
            on LocationEventWithDistance(source = firstPos.source) as secondPos {
                if firstPos.distance &lt;= firstPos.maxDistance and
                   secondPos.distance &gt; secondPos.maxDistance {
                    send Alarm(&quot;&quot;, &quot;c8y_GeofenceAlarm&quot;, firstPos.source, currentTime,
                               &quot;Device moved out of circular geofence&quot;,
                                &quot;ACTIVE&quot;, &quot;MAJOR&quot;, 1, new dictionary&lt;string,any&gt;) to Alarm.CHANNEL;
                }
                if firstPos.distance &gt; firstPos.maxDistance and secondPos.distance &lt;= secondPos.maxDistance {
                    integer reqId:= integer.getUnique();
                    send FindAlarm(reqId, {&quot;source&quot;:firstPos.source,
                                   &quot;status&quot;:&quot;ACTIVE&quot;,&quot;type&quot;:&quot;c8y_GeofenceAlarm&quot;}) to FindAlarm.CHANNEL;
                    on FindAlarmResponse(reqId = reqId) as alarmResponse
                       and not FindAlarmResponseAck(reqId=reqId) {
                        send Alarm(alarmResponse.id,
                                   &quot;c8y_GeofenceAlarm&quot;, firstPos.source, currentTime,
                                   &quot;Device moved back into circular geofence&quot;, &quot;CLEARED&quot;,
                                   &quot;MAJOR&quot;, 1, new dictionary&lt;string, any&gt;) to
                             Alarm.CHANNEL;
                    }
                }
            }
        }
    }

    action distance(float lat1, float lon1, float lat2, float lon2) returns float {
        float R := 6371000.0;
        float toRad := float.PI / 180.0;
        float lat1Rad := lat1 * toRad;
        float lat2Rad := lat2 * toRad;
        float deltaLatRad := (lat2-lat1) * toRad;
        float deltaLonRad := (lat2-lat1) * toRad;
        float a := (deltaLatRad/2.0).sin().pow(2.0) * lat1Rad.cos() * lat2Rad.cos() * (deltaLonRad/2.0).sin().pow(2.0);
        float c := 2.0 * a.sqrt().atan2((1.0-a).sqrt());
        return R * c;
    }
}
</code></pre>

  </article>
  
  
</div>
<footer class="main-footer">
  <div class="copyright">
    <div class="container text-center">
      <p class="small ">&copy; 2019 Cumulocity GmbH | All rights reserved.</p>
    </div>
  </div>  
</footer>

<!-- Essential Scripts -->

<!-- jQuery -->
<script src="https://cumulocity.com/guides/js/vendor/jquery.min.js"></script>
<script src="https://cumulocity.com/guides/js/vendor/bootstrap.bundle.min.js"></script>
<script src="https://cumulocity.com/guides/js/vendor/clipboard.js"></script>
<script src="https://cumulocity.com/guides/js/vendor/zoom.js"></script>
<script src="https://cumulocity.com/guides/js/vendor/highlight.min.js"></script>
<script src="https://cumulocity.com/guides/js/main.js"></script>





    
   
  </body>
</html>
